---

# ***

# Ensure ~/.local/bin/bash exists, which some panel launchers use rather
# than, e.g., /bin/bash. This is useful if you want to use a custom Bash.
- name: Stat ~/.local/bin/bash
  ansible.builtin.stat: path="{{ ansible_env.HOME }}/.local/bin/bash"
  register: local_bin_bash_f

- name: Symlink ~/.local/bin/bash if not exists
  ansible.builtin.file:
    src: "/bin/bash"
    dest: "{{ ansible_env.HOME }}/.local/bin/bash"
    state: link
  when: not local_bin_bash_f.stat.exists

# ***

# CPYST:
#   dconf dump /org/mate/panel/
- name: Reset Existing MATE Panel DConf, and Clear ~/.config/mate/panel2.d/default/launchers/
  ansible.builtin.shell: dconf reset -f /org/mate/panel/

- name: Kill Off MATE Panel While We Work — Restarts it with default launchers
  ansible.builtin.shell: killall -s 9 mate-panel

# ***

# E.g.,:
#   /bin/rm -rf ~/.config/mate/panel2.d/default/launchers/
- name: Clear Existing MATE Panel Launcher Files
  ansible.builtin.file:
    state: absent
    path: "{{ ansible_env.HOME }}/.config/mate/panel2.d/default/launchers/"

# CPYST:
#   ll ~/.config/mate/panel2.d/default/launchers/
- name: Ensure MATE Panel Launcher Directory Exists
  ansible.builtin.file:
    state: directory
    path: "{{ ansible_env.HOME }}/.config/mate/panel2.d/default/launchers/"

- name: Deploy Most MATE Panel Launchers
  ansible.builtin.template:
    src: "{{ item }}"
    dest:
      "{{ ansible_env.HOME }}/.config/mate/panel2.d/default/launchers/{{
        item | basename | regex_replace('\\.j2$','')
      }}"
  with_fileglob:
    - ../templates/launchers/*.desktop*

- name: Deploy Dubs Vim Edit MATE Panel Launchers \#s 1-10
  ansible.builtin.template:
    src: ../templates/dubs-vim.desktop.j2
    dest: "{{ ansible_env.HOME }}/.config/mate/panel2.d/default/launchers/{{ item.id }}.desktop"
  vars:
    zoidy_matecocido_dubs_vim_name: "{{ item.name }}"
    zoidy_matecocido_dubs_vim_edit: "{{ item.edit }}"
    zoidy_matecocido_dubs_vim_icon: "{{ item.icon }}"
  loop: "{{ zoidy_matecocido_dubs_vim_launchers }}"

# ***

# CPYST:
#   ll ~/.config/zoidy_matecocido/icons/
- name: Deploy (Synchronize) MATE Panel Launcher Icons
  ansible.builtin.synchronize:
    src: "../files/launcher-icons/"
    dest: "{{ ansible_env.HOME }}/.config/zoidy_matecocido/icons/"
    delete: yes

# ***

- ansible.builtin.set_fact:
    list_sep: "', '"

- name: Format custom panel object IDs list
  ansible.builtin.set_fact:
    custom_object_ids: ", '{{ zoidy_matecocido_panel_objects | map(attribute='object_id') | join(list_sep) }}'"

# BEWARE: If you specify a position that causes overlap, mate-panel crashes.
#
# E.g., the following config
#
#   [objects/notification-area]
#   # position=1382
#   position=1409
#   ...
#
#   [objects/zoidy-workspace-switcher]
#   position=1562
#   ...
#
# crashes mate-panel.
#
# You can restart `mate-panel &`
# after fixing the error.
#
# Oddly, after you set the config, you can unlock notification-area
# and move it rightward, so that its position is the same value that
# crashed mate-panel. Oh, well.
- name: Format default panel DConf, including custom object IDs
  ansible.builtin.set_fact:
    org_mate_panel_dconf: "{{ lookup('template', 'templates/org-mate-panel.dconf.j2') }}"

# ***

- name: Generate custom panel sections
  ansible.builtin.shell: |
    echo "[objects/{{ item.object_id }}]
    toplevel-id='bottom'
    object-type='launcher'
    launcher-location={{ item.launcher_location }}
    position={{ item.position }}
    locked=true
    panel-right-stick=false
    "
  # position={{ 36 + (index > 1 and 35 or 0) + (index > 2 and (31 * (index - 2)) or 0) }}
  # 2023-04-22: Some launchers in Mint 21.1 (Firefox, mate-terminal, caja) include menu-path:
  #   menu-path='applications:/'
  # 2023-04-22: Default Mint 21.1 shows only 'panel-right-stick=true' usage.
  # - I.e., defaults false, so don't need to specify.
  register: dconf_launcher_cmds
  loop: "{{ zoidy_matecocido_panel_objects }}"
  loop_control:
    index_var: index

- name: Format custom MATE panel DConf parts
  ansible.builtin.set_fact:
    dconf_launcher_objects: "{{ dconf_launcher_cmds.results | map(attribute='stdout') | join('\n') }}"

# ***

- name: Load Custom MATE Panel DConf
  ansible.builtin.shell: dconf load /org/mate/panel/
  args:
    stdin: "{{ org_mate_panel_dconf + dconf_launcher_objects }}"

- name: One last kill mate-panel — Restart mate-panel so it renders correctly
  ansible.builtin.shell: killall -s 9 mate-panel

